<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>footway-widget</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>

  <div id="container"></div>

  <script type="text/javascript" src="globe/third-party/Detector.js"></script>
  <script type="text/javascript" src="globe/third-party/three.min.js"></script>
  <script type="text/javascript" src="globe/third-party/Tween.js"></script>
  <script type="text/javascript">

    // Options for the widget
    window.rotationSpeedX = 3; // [..., -2, -1, 0, 1, 2, ...];
    window.colorsPossibleLuminance = [1.6, 1.5, 1.4, 1.05];

  </script>
  <script type="text/javascript" src="globe/globe.js"></script>
  <script type="text/javascript">

    if (!Detector.webgl) {
        Detector.addGetWebGLMessage();
    } else {
        var container = document.getElementById('container');
        var globe = new DAT.Globe(container);

        var url = 'data.json'

        var xhr = new XMLHttpRequest();
        xhr.open( 'GET', url, true );

        function getRandomColor() {
            var colors = window.colorsPossibleLuminance;
            return colors[Math.floor(Math.random() * colors.length)]
        }

        // What do we do when we have it?
        xhr.onreadystatechange = function() {

            // If we've received the data
            if ( xhr.readyState === 4 && xhr.status === 200 ) {

                // Parse the JSON
                // var data = JSON.parse( xhr.responseText ).rows;
                // var maxValue = data.map(data => data[2]).reduce((a, b) => a > b ? a : b)
                // var rawdata = data
                //     .map(data => [data[0], data[1], Math.sqrt(data[2]) / maxValue, getRandomColor()])
                //     .reduce((a, b) => a.concat(b), []);

                var data = JSON.parse( xhr.responseText );
                var rawdata = data
                    .map(function(row) {return [row.latitude, row.longitude, .5, getRandomColor()]; })
                    .reduce(function(a, b) { return a.concat(b); }, []);

                // Tell the globe about your JSON data
                globe.addData(rawdata, {format: 'legend', name: 'meh'} );

                // Create the geometry
                globe.createPoints();

                // Begin animation
                globe.animate();

            }

        };

        // Begin request
        xhr.send( null );

        // Create the geometry
        globe.createPoints();

        // Begin animation
        globe.animate();
    }

  </script>
  </body>
</html>
